<script>
  const TIKTOK_LITE_URL = "https://lite.tiktok.com/t/ZSHEmMN7ug6nV-kWyjB/";

  const statusEl = document.getElementById("status");
  const openBtn  = document.getElementById("openBtn");
  const fulltap  = document.getElementById("fulltap");

  let locked = false;

  function isThreadsInApp() {
    const ua = navigator.userAgent || "";
    return /Threads|Instagram|FBAN|FBAV/i.test(ua);
  }

  function makeIntent(url, pkg) {
    const u = new URL(url);
    return `intent://${u.host}${u.pathname}${u.search}#Intent;scheme=${u.protocol.replace(":","")};package=${pkg};end`;
  }

  const INTENT_TIKTOK_LITE = makeIntent(TIKTOK_LITE_URL, "com.ss.android.ugc.trill");
  const INTENT_TIKTOK      = makeIntent(TIKTOK_LITE_URL, "com.zhiliaoapp.musically");

  function openOnce() {
    if (locked) return;
    locked = true;

    statusEl.textContent = "読み込み中…";

    // まず通常URL（ここだけで開く端末もある）
    location.href = TIKTOK_LITE_URL;

    // 通常ブラウザ（Chrome等）では intent も併用して成功率UP
    if (!isThreadsInApp()) {
      setTimeout(() => { location.href = INTENT_TIKTOK_LITE; }, 120);
      setTimeout(() => { location.href = INTENT_TIKTOK;      }, 240);
    }

    setTimeout(() => { locked = false; }, 1500);
  }

  openBtn.addEventListener("click", (e) => { e.preventDefault(); openOnce(); });
  fulltap.addEventListener("click", (e) => { e.preventDefault(); openOnce(); });

  // ★ここが肝：Chromeで開いた瞬間に即アプリへ（中間ページを見せない）
  window.addEventListener("load", () => {
    if (!isThreadsInApp()) {
      setTimeout(openOnce, 50);
    }
  });
</script>
